<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario dell'Avvento</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
<div class="header-container">
    <h1>Calendario dell'Avvento</h1>
    <p>Un viaggio di 24 giorni di Meraviglia</p>
</div>

<div class="calendario-grid-container" id="calendario">
    <!-- I giorni verranno generati dinamicamente -->
</div>

<!-- Modal Principale -->
<div class="modal-overlay" id="modal">
    <div class="modal-content">
        <!-- Intestazione con Navigazione -->
        <div class="navigazione-giorni">
            <button class="btn-navigazione" onclick="cambiaGiorno(-1)">‚Üê Porta precedente</button>
            <div class="giorno-corrente">
                <span class="data-giorno" id="dataGiorno">1 dicembre</span>
                <span class="numero-giorno" id="numeroGiorno">1</span>
            </div>
            <button class="btn-navigazione" onclick="cambiaGiorno(1)">Accanto ‚Üí</button>
        </div>

        <!-- Anteprima Contenuto -->
        <div class="anteprima-contenuto" id="anteprimaContenuto">
            <div id="contenutoVisuale">
                <p class="nessun-contenuto">Nessun contenuto per questo giorno</p>
            </div>
        </div>

        <!-- Controllo Spazio -->
        <div class="controllo-spazio">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 0.9em;">üíæ Spazio: <strong id="spazioUtilizzato">0MB</strong></span>
                <button onclick="controllaSpazioDisponibile()" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; cursor: pointer;">
                    Controlla
                </button>
                <button onclick="pulisciSpazio()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; cursor: pointer;">
                    Pulisci Tutto
                </button>
            </div>
        </div>

        <!-- Selezione Tipo Contenuto -->
        <div class="selezione-tipo">
            <h4>Scegli il tipo di contenuto:</h4>
            <div class="grid-tipo-contenuto">
                <button class="btn-tipo" onclick="selezionaTipo('foto')">
                    <span class="icona">üì∏</span>
                    <span>Foto</span>
                </button>
                <button class="btn-tipo" onclick="selezionaTipo('messaggio')">
                    <span class="icona">üí¨</span>
                    <span>Messaggio</span>
                </button>
                <button class="btn-tipo" onclick="selezionaTipo('messaggio-vocale')">
                    <span class="icona">üé§</span>
                    <span>Messaggio vocale</span>
                </button>
                <button class="btn-tipo" onclick="selezionaTipo('audio')">
                    <span class="icona">üéµ</span>
                    <span>Audio</span>
                </button>
                <button class="btn-tipo" onclick="selezionaTipo('musica')">
                    <span class="icona">üé∂</span>
                    <span>Musica</span>
                </button>
                <button class="btn-tipo" onclick="selezionaTipo('youtube')">
                    <span class="icona">‚ñ∂Ô∏è</span>
                    <span>Video di YouTube</span>
                </button>
                <button class="btn-tipo" onclick="selezionaTipo('video')">
                    <span class="icona">üé•</span>
                    <span>Video</span>
                </button>
            </div>
        </div>

        <!-- Editor Dinamico -->
        <div class="editor-dinamico" id="editorDinamico">
            <div id="editorContainer"></div>
        </div>

        <!-- Azioni -->
        <div class="azioni">
            <button class="bottone" onclick="salvaContenuto()">üíæ Salva</button>
            <button class="bottone-elimina" onclick="eliminaContenuto()">üóëÔ∏è Elimina</button>
            <button class="bottone-chiusura" onclick="chiudiModale()">‚ùå Chiudi</button>
        </div>

        <!-- Info Debug -->
        <div class="debug-info">
            <span>Giorno: <strong id="debugDay">-</strong></span>
            <span>Tipo: <strong id="debugTipo">-</strong></span>
        </div>
    </div>
</div>

<script>
    // Variabili globali
    const calendario = document.getElementById("calendario");
    const modale = document.getElementById("modal");
    const contenutoVisuale = document.getElementById("contenutoVisuale");
    const editorDinamico = document.getElementById("editorDinamico");
    const editorContainer = document.getElementById("editorContainer");
    const dataGiorno = document.getElementById("dataGiorno");
    const numeroGiorno = document.getElementById("numeroGiorno");
    const debugDay = document.getElementById("debugDay");
    const debugTipo = document.getElementById("debugTipo");

    let currentDay = null;
    let currentTipo = null;
    let currentFile = null;

    // 1. Generazione calendario
    function generaCalendario() {
        calendario.innerHTML = '';
        for (let i = 1; i <= 24; i++) {
            const giorno = document.createElement("button");
            giorno.classList.add("pulsante");
            giorno.innerHTML = `
                <span class="numero-giorno">${i}</span>
                <span class="data-giorno">${i} dicembre</span>
            `;
            giorno.setAttribute('data-giorno', i);
            giorno.onclick = () => apriGiornata(i); 
            calendario.appendChild(giorno);
            aggiornaStatoPulsante(i);
        }
    }

    // 2. Aggiorna stato pulsante
    function aggiornaStatoPulsante(giorno) {
        const pulsante = document.querySelector(`.pulsante[data-giorno="${giorno}"]`);
        if (!pulsante) return;
        
        const savedContent = localStorage.getItem(`giorno${giorno}`);
        if (savedContent && savedContent.trim() !== '') {
            pulsante.classList.add('contenutoSalvato');
        } else {
            pulsante.classList.remove('contenutoSalvato');
        }
    }

    // 3. Apri giornata
    function apriGiornata(giorno) {
        currentDay = giorno;
        debugDay.textContent = giorno;
        
        // Aggiorna interfaccia
        dataGiorno.textContent = `${giorno} dicembre`;
        numeroGiorno.textContent = giorno;
        
        // Resetta selezione tipo
        currentTipo = null;
        currentFile = null;
        debugTipo.textContent = '-';
        editorContainer.innerHTML = '';
        editorDinamico.style.display = 'none';
        
        // Carica contenuto salvato
        const savedContent = localStorage.getItem(`giorno${giorno}`);
        visualizzaContenuto(savedContent);
        
        // Aggiorna spazio utilizzato
        aggiornaSpazioUtilizzato();
        
        modale.classList.add("mostra");
    }

    // 4. Selezione tipo contenuto
    function selezionaTipo(tipo) {
        currentTipo = tipo;
        debugTipo.textContent = tipo;
        
        // Rimuovi selezione precedente
        document.querySelectorAll('.btn-tipo').forEach(btn => {
            btn.classList.remove('selezionato');
        });
        
        // Aggiungi selezione corrente
        event.currentTarget.classList.add('selezionato');
        
        // Mostra editor appropriato
        editorDinamico.style.display = 'block';
        mostraEditorPerTipo(tipo);
    }

    // 5. Mostra editor per tipo
    function mostraEditorPerTipo(tipo) {
        let html = '';
        
        switch(tipo) {
            case 'foto':
                html = `
                    <div class="editor-tipo">
                        <h4>üì∏ Carica Foto</h4>
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <p>üìÅ Clicca qui per selezionare un'immagine</p>
                            <small>Formati: JPG, PNG, GIF (max 5MB)</small>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="gestisciFileSelezionato(this)">
                        <div id="anteprimaFile" style="margin-top: 15px;"></div>
                        <div class="link-alternativo">
                            <p>üîó Oppure incolla link immagine:</p>
                            <input type="text" id="linkFoto" placeholder="https://esempio.com/foto.jpg">
                        </div>
                    </div>
                `;
                break;
                
            case 'messaggio':
                html = `
                    <div class="editor-tipo">
                        <h4>üí¨ Scrivi Messaggio</h4>
                        <textarea id="testoMessaggio" placeholder="Scrivi il tuo messaggio speciale..."></textarea>
                        <div class="suggerimenti-testo">
                            <button type="button" onclick="inserisciTestoEsempio()">
                                üéÑ Inserisci testo esempio
                            </button>
                        </div>
                    </div>
                `;
                break;
                
            case 'youtube':
                html = `
                    <div class="editor-tipo">
                        <h4>‚ñ∂Ô∏è Link YouTube</h4>
                        <input type="text" id="linkYouTube" placeholder="Incolla qui il link di YouTube...">
                        <div class="esempi-link">
                            <small>üìã Esempi: 
                                <br>‚Ä¢ https://youtube.com/watch?v=CODICE
                                <br>‚Ä¢ https://youtu.be/CODICE
                            </small>
                        </div>
                    </div>
                `;
                break;
                
            case 'messaggio-vocale':
                html = `
                    <div class="editor-tipo">
                        <h4>üé§ Messaggio Vocale</h4>
                        <div class="upload-area" onclick="document.getElementById('fileAudioVocale').click()">
                            <p>üéôÔ∏è Carica file audio</p>
                            <small>Formati: MP3, WAV, M4A (max 10MB)</small>
                        </div>
                        <input type="file" id="fileAudioVocale" accept="audio/*" style="display: none;" onchange="gestisciFileSelezionato(this)">
                        <div id="anteprimaAudio" style="margin-top: 15px;"></div>
                        <div class="link-alternativo">
                            <p>üîó Oppure incolla link audio:</p>
                            <input type="text" id="linkAudioVocale" placeholder="https://esempio.com/audio.mp3">
                        </div>
                    </div>
                `;
                break;
                
            case 'audio':
            case 'musica':
                html = `
                    <div class="editor-tipo">
                        <h4>${tipo === 'audio' ? 'üéµ File Audio' : 'üé∂ Brano Musicale'}</h4>
                        <div class="upload-area" onclick="document.getElementById('fileAudio${tipo}').click()">
                            <p>üìÅ Carica file audio</p>
                            <small>Formati: MP3, WAV, OGG (max 10MB)</small>
                        </div>
                        <input type="file" id="fileAudio${tipo}" accept="audio/*" style="display: none;" onchange="gestisciFileSelezionato(this)">
                        <div id="anteprimaAudio${tipo}" style="margin-top: 15px;"></div>
                        <div class="link-alternativo">
                            <p>üîó Oppure incolla link audio:</p>
                            <input type="text" id="linkAudio${tipo}" placeholder="https://esempio.com/audio.mp3">
                        </div>
                    </div>
                `;
                break;
                
            case 'video':
                html = `
                    <div class="editor-tipo">
                        <h4>üé• Carica Video</h4>
                        <div class="upload-area" onclick="document.getElementById('fileVideo').click()">
                            <p>üìÅ Carica file video</p>
                            <small>Formati: MP4, WebM (max 20MB)</small>
                        </div>
                        <input type="file" id="fileVideo" accept="video/*" style="display: none;" onchange="gestisciFileSelezionato(this)">
                        <div id="anteprimaVideo" style="margin-top: 15px;"></div>
                        <div class="link-alternativo">
                            <p>üîó Oppure incolla link video:</p>
                            <input type="text" id="linkVideo" placeholder="https://esempio.com/video.mp4">
                        </div>
                    </div>
                `;
                break;
        }
        
        editorContainer.innerHTML = html;
        currentFile = null;
    }

    // 6. Gestione file selezionato
    function gestisciFileSelezionato(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            currentFile = file;
            
            // LIMITI AUMENTATI
            let maxSize = 5 * 1024 * 1024; // 5MB per immagini
            if (currentTipo === 'audio' || currentTipo === 'musica' || currentTipo === 'messaggio-vocale') {
                maxSize = 10 * 1024 * 1024; // 10MB per audio
            } else if (currentTipo === 'video') {
                maxSize = 20 * 1024 * 1024; // 20MB per video
            }
            
            if (file.size > maxSize) {
                alert(`‚ùå File troppo grande! Massimo ${maxSize/(1024*1024)}MB`);
                input.value = '';
                currentFile = null;
                return;
            }
            
            // Avviso per file grandi
            if (file.size > 2 * 1024 * 1024) {
                const conferma = confirm(`‚ö†Ô∏è Questo file √® grande (${(file.size/1024/1024).toFixed(1)}MB).\n\nIl salvataggio potrebbe essere lento e occupare molto spazio.\nVuoi continuare?`);
                if (!conferma) {
                    input.value = '';
                    currentFile = null;
                    return;
                }
            }
            
            // Anteprima
            const reader = new FileReader();
            reader.onload = function(e) {
                let anteprimaHTML = '';
                const containerId = `anteprima${currentTipo.charAt(0).toUpperCase() + currentTipo.slice(1)}`;
                
                if (currentTipo === 'foto') {
                    anteprimaHTML = `
                        <div class="anteprima-contenuto">
                            <img src="${e.target.result}">
                            <p>‚úÖ ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)</p>
                            ${file.size > 2 * 1024 * 1024 ? '<p class="avviso-grande">‚ö†Ô∏è File di grandi dimensioni</p>' : ''}
                        </div>
                    `;
                } else if (currentTipo === 'video') {
                    anteprimaHTML = `
                        <div class="anteprima-contenuto">
                            <video controls>
                                <source src="${e.target.result}" type="${file.type}">
                            </video>
                            <p>üé• ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)</p>
                            ${file.size > 5 * 1024 * 1024 ? '<p class="avviso-grande">‚ö†Ô∏è File di grandi dimensioni</p>' : ''}
                        </div>
                    `;
                } else {
                    anteprimaHTML = `
                        <div class="anteprima-contenuto">
                            <p>üéµ ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)</p>
                            <audio controls>
                                <source src="${e.target.result}" type="${file.type}">
                            </audio>
                            ${file.size > 5 * 1024 * 1024 ? '<p class="avviso-grande">‚ö†Ô∏è File di grandi dimensioni</p>' : ''}
                        </div>
                    `;
                }
                
                document.getElementById(containerId).innerHTML = anteprimaHTML;
            };
            
            reader.readAsDataURL(file);
        }
    }

    // 7. Testo esempio
    function inserisciTestoEsempio() {
        const esempi = [
            "üéÑ Che questo Natale porti gioia e serenit√† nel tuo cuore!",
            "üåü Possano le luci del Natale illuminare il tuo cammino!",
            "‚ùÑÔ∏è Che la magia di questo periodo ti avvolga di felicit√†!",
            "üéÅ I migliori auguri per te e la tua famiglia!",
            "üïØÔ∏è Che lo spirito natalizio riscaldi il tuo cuore!",
            "‚ú® Che il tuo Natale sia pieno di amore e risate!"
        ];
        const esempio = esempi[Math.floor(Math.random() * esempi.length)];
        document.getElementById('testoMessaggio').value = esempio;
    }

    // 8. Salva contenuto
    async function salvaContenuto() {
        if (!currentDay) {
            alert('‚ùå Nessun giorno selezionato!');
            return;
        }

        if (!currentTipo) {
            alert('‚ùå Seleziona un tipo di contenuto!');
            return;
        }

        let contentData = {
            tipo: currentTipo,
            valore: '',
            extra: ''
        };

        try {
            switch(currentTipo) {
                case 'foto':
                    const linkFoto = document.getElementById('linkFoto');
                    if (linkFoto && linkFoto.value) {
                        contentData.valore = linkFoto.value;
                        contentData.extra = 'link';
                    } else if (currentFile) {
                        contentData.valore = await fileToDataURL(currentFile);
                        contentData.extra = currentFile.name;
                    } else {
                        alert('‚ùå Seleziona un file o inserisci un link!');
                        return;
                    }
                    break;
                    
                case 'messaggio':
                    const testo = document.getElementById('testoMessaggio');
                    if (testo && testo.value.trim()) {
                        contentData.valore = testo.value.trim();
                    } else {
                        alert('‚ùå Scrivi un messaggio!');
                        return;
                    }
                    break;
                    
                case 'youtube':
                    const linkYT = document.getElementById('linkYouTube');
                    if (linkYT && linkYT.value.trim()) {
                        const videoId = getYoutubeVideoId(linkYT.value.trim());
                        if (videoId) {
                            contentData.valore = videoId;
                            contentData.extra = linkYT.value.trim();
                        } else {
                            alert('‚ùå Link YouTube non valido!');
                            return;
                        }
                    } else {
                        alert('‚ùå Inserisci un link YouTube!');
                        return;
                    }
                    break;
                    
                case 'messaggio-vocale':
                case 'audio':
                case 'musica':
                    const linkAudio = document.getElementById(`linkAudio${currentTipo}`) || document.getElementById('linkAudioVocale');
                    if (linkAudio && linkAudio.value) {
                        contentData.valore = linkAudio.value;
                        contentData.extra = 'link';
                    } else if (currentFile) {
                        contentData.valore = await fileToDataURL(currentFile);
                        contentData.extra = currentFile.name;
                    } else {
                        alert('‚ùå Seleziona un file o inserisci un link!');
                        return;
                    }
                    break;
                    
                case 'video':
                    const linkVideo = document.getElementById('linkVideo');
                    if (linkVideo && linkVideo.value) {
                        contentData.valore = linkVideo.value;
                        contentData.extra = 'link';
                    } else if (currentFile) {
                        contentData.valore = await fileToDataURL(currentFile);
                        contentData.extra = currentFile.name;
                    } else {
                        alert('‚ùå Seleziona un file o inserisci un link!');
                        return;
                    }
                    break;
            }

            // Salva nel localStorage
            const contentString = JSON.stringify(contentData);
            localStorage.setItem(`giorno${currentDay}`, contentString);
            
            // Aggiorna interfaccia
            aggiornaStatoPulsante(currentDay);
            visualizzaContenuto(contentString);
            aggiornaSpazioUtilizzato();
            
            alert(`‚úÖ ${getTipoNome(currentTipo)} salvato per il Giorno ${currentDay}!`);
            
        } catch (error) {
            console.error('Errore salvataggio:', error);
            if (error.name === 'QuotaExceededError') {
                alert('‚ùå Spazio di archiviazione pieno! Elimina qualche contenuto o usa file pi√π piccoli.');
            } else {
                alert('‚ùå Errore nel salvataggio: ' + error.message);
            }
        }
    }

    // 8.1 Converti file in Data URL
    function fileToDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // 8.2 Ottieni nome tipo
    function getTipoNome(tipo) {
        const nomi = {
            'foto': 'Foto',
            'messaggio': 'Messaggio',
            'youtube': 'Video YouTube',
            'messaggio-vocale': 'Messaggio vocale',
            'audio': 'Audio',
            'musica': 'Musica',
            'video': 'Video'
        };
        return nomi[tipo] || 'Contenuto';
    }

    // 9. Visualizza contenuto
    function visualizzaContenuto(content) {
        if (!content) {
            contenutoVisuale.innerHTML = '<p class="nessun-contenuto">Nessun contenuto per questo giorno</p>';
            return;
        }

        try {
            const contentData = JSON.parse(content);
            
            switch(contentData.tipo) {
                case 'foto':
                    if (contentData.valore.startsWith('data:')) {
                        // Immagine salvata come Data URL
                        contenutoVisuale.innerHTML = `
                            <div class="anteprima-tipo">
                                <h4>üì∏ Foto Caricata</h4>
                                <img src="${contentData.valore}">
                                <p>${contentData.extra || 'Immagine salvata'}</p>
                            </div>
                        `;
                    } else {
                        // Link immagine
                        contenutoVisuale.innerHTML = `
                            <div class="anteprima-tipo">
                                <h4>üì∏ Foto da Link</h4>
                                <img src="${contentData.valore}" onerror="this.style.display='none'; this.parentNode.innerHTML='<p style=\\'color:red;\\'>‚ùå Immagine non caricabile</p><a href=\\'${contentData.valore}\\' target=\\'_blank\\'>Apri link originale</a>'">
                                <p><a href="${contentData.valore}" target="_blank">üîó Apri link originale</a></p>
                            </div>
                        `;
                    }
                    break;
                    
                case 'messaggio':
                    contenutoVisuale.innerHTML = `
                        <div class="anteprima-tipo">
                            <h4>üí¨ Messaggio</h4>
                            <div class="messaggio-testo">${contentData.valore.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                    break;
                    
                case 'youtube':
                    contenutoVisuale.innerHTML = `
                        <div class="anteprima-tipo">
                            <h4>‚ñ∂Ô∏è Video YouTube</h4>
                            <iframe width="100%" height="250" 
                                    src="https://www.youtube.com/embed/${contentData.valore}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                            <p><a href="${contentData.extra}" target="_blank">üîó Apri su YouTube</a></p>
                        </div>
                    `;
                    break;
                    
                case 'messaggio-vocale':
                case 'audio':
                case 'musica':
                    if (contentData.valore.startsWith('data:')) {
                        contenutoVisuale.innerHTML = `
                            <div class="anteprima-tipo">
                                <h4>${contentData.tipo === 'musica' ? 'üé∂ Musica' : 'üéµ Audio'}</h4>
                                <audio controls>
                                    <source src="${contentData.valore}" type="audio/mpeg">
                                </audio>
                                <p>${contentData.extra || 'File audio'}</p>
                            </div>
                        `;
                    } else {
                        contenutoVisuale.innerHTML = `
                            <div class="anteprima-tipo">
                                <h4>${contentData.tipo === 'musica' ? 'üé∂ Musica' : 'üéµ Audio'}</h4>
                                <audio controls>
                                    <source src="${contentData.valore}" type="audio/mpeg">
                                </audio>
                                <p><a href="${contentData.valore}" target="_blank">üîó Apri link originale</a></p>
                            </div>
                        `;
                    }
                    break;
                    
                case 'video':
                    if (contentData.valore.startsWith('data:')) {
                        contenutoVisuale.innerHTML = `
                            <div class="anteprima-tipo">
                                <h4>üé• Video</h4>
                                <video controls>
                                    <source src="${contentData.valore}" type="video/mp4">
                                </video>
                                <p>${contentData.extra || 'File video'}</p>
                            </div>
                        `;
                    } else {
                        contenutoVisuale.innerHTML = `
                            <div class="anteprima-tipo">
                                <h4>üé• Video</h4>
                                <video controls>
                                    <source src="${contentData.valore}" type="video/mp4">
                                </video>
                                <p><a href="${contentData.valore}" target="_blank">üîó Apri link originale</a></p>
                            </div>
                        `;
                    }
                    break;
                    
                default:
                    contenutoVisuale.innerHTML = `
                        <div class="anteprima-tipo">
                            <h4>üìÅ Contenuto</h4>
                            <p>${contentData.valore}</p>
                        </div>
                    `;
            }
        } catch (error) {
            console.error('Errore visualizzazione contenuto:', error);
            contenutoVisuale.innerHTML = `
                <div class="anteprima-tipo">
                    <h4>‚ö†Ô∏è Errore</h4>
                    <p>Contenuto non valido o corrotto</p>
                </div>
            `;
        }
    }

    // 10. Funzione helper per YouTube
    function getYoutubeVideoId(url) {
        if (!url) return null;
        
        const patterns = [
            /(?:youtube\.com\/watch\?v=)([^&]+)/,
            /(?:youtu\.be\/)([^?]+)/,
            /(?:youtube\.com\/embed\/)([^?]+)/,
            /(?:youtube\.com\/v\/)([^?]+)/
        ];
        
        for (let pattern of patterns) {
            const match = url.match(pattern);
            if (match && match[1]) {
                return match[1];
            }
        }
        
        return null;
    }

    // 11. Elimina contenuto
    function eliminaContenuto() {
        if (!currentDay) return;
        
        if (confirm(`Sei sicuro di voler eliminare il contenuto del Giorno ${currentDay}?`)) {
            localStorage.removeItem(`giorno${currentDay}`);
            aggiornaStatoPulsante(currentDay);
            visualizzaContenuto(null);
            editorContainer.innerHTML = '';
            editorDinamico.style.display = 'none';
            currentTipo = null;
            currentFile = null;
            debugTipo.textContent = '-';
            aggiornaSpazioUtilizzato();
            alert(`üóëÔ∏è Contenuto eliminato!`);
        }
    }

    // 12. Navigazione tra giorni
    function cambiaGiorno(direzione) {
        if (!currentDay) return;
        
        const nuovoGiorno = currentDay + direzione;
        if (nuovoGiorno >= 1 && nuovoGiorno <= 24) {
            apriGiornata(nuovoGiorno);
        }
    }

    // 13. Controllo spazio disponibile
    function controllaSpazioDisponibile() {
        let totale = 0;
        for (let i = 1; i <= 24; i++) {
            const content = localStorage.getItem(`giorno${i}`);
            if (content) {
                totale += new Blob([content]).size;
            }
        }
        
        const totaleMB = (totale / (1024 * 1024)).toFixed(1);
        const limiteMB = 50;
        
        console.log(`Spazio utilizzato: ${totaleMB}MB / ${limiteMB}MB`);
        
        if (totaleMB > limiteMB * 0.8) {
            alert(`‚ö†Ô∏è Attenzione: stai usando ${totaleMB}MB di spazio.\n\nPotresti raggiungere presto il limite massimo.`);
        }
        
        return totaleMB;
    }

    // 14. Aggiorna display spazio
    function aggiornaSpazioUtilizzato() {
        const spazioMB = controllaSpazioDisponibile();
        document.getElementById('spazioUtilizzato').textContent = `${spazioMB}MB`;
    }

    // 15. Pulisci spazio
    function pulisciSpazio() {
        if (confirm('Vuoi eliminare TUTTI i contenuti del calendario?\nQuesta azione non pu√≤ essere annullata.')) {
            for (let i = 1; i <= 24; i++) {
                localStorage.removeItem(`giorno${i}`);
            }
            generaCalendario();
            aggiornaSpazioUtilizzato();
            alert('üóëÔ∏è Tutti i contenuti sono stati eliminati!');
        }
    }

    // 16. Chiudi modale
    function chiudiModale() {
        modale.classList.remove("mostra");
        currentDay = null;
        currentTipo = null;
        currentFile = null;
    }

    // 17. Inizializzazione
    document.addEventListener('DOMContentLoaded', function() {
        generaCalendario();
        
        // Chiudi modal cliccando fuori
        modale.addEventListener('click', function(e) {
            if (e.target === modale) chiudiModale();
        });
        
        // Tasto ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') chiudiModale();
        });
        
        console.log("üéÑ Calendario dell'Avvento inizializzato!");
    });
</script>

</body>
</html>

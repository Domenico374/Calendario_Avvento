<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario dell'Avvento</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
<div class="header-container">
    <h1>Calendario dell'Avvento</h1>
    <p>Un viaggio di 24 giorni di Meraviglia</p>
</div>

<div class="calendario-grid-container" id="calendario">
    <!-- I giorni verranno generati dinamicamente -->
</div>

<div class="modal-overlay" id="modal">
    <div class="modal-content">
        <h3 id="titoloGiorno">Giorno 1</h3>
        <div id="contenutoVisuale">
            <p style="color: #666; font-style: italic;">Nessun contenuto salvato per questo giorno</p>
        </div> 
        
        <div class="editor-container">
            <p><strong>Aggiungi il tuo contenuto:</strong></p>
            <div class="azioni-rapide">
                <button type="button" onclick="inserisciTestoEsempio()">üìù Testo esempio</button>
                <button type="button" onclick="mostraAiutoImmagini()">üñºÔ∏è Aiuto immagini</button>
            </div>
            <div id="editor" contenteditable="true" placeholder="Scrivi qui il tuo messaggio, incolla un link YouTube, o un link immagine..."></div>
            <div class="suggerimenti">
                <p><small>üí° <strong>Suggerimenti:</strong> Incolla direttamente link YouTube o link immagini. Per immagini, usa servizi come Imgur.com</small></p>
            </div>
        </div>
        
        <div class="azioni">
            <button class="bottone" onclick="salvaContenuto()">üíæ Salva</button>
            <button class="bottone-elimina" onclick="eliminaContenuto()">üóëÔ∏è Elimina</button>
            <button class="bottone-chiusura" onclick="chiudiModale()">‚ùå Chiudi</button>
        </div>
        
        <div class="debug-info" style="margin-top: 15px; font-size: 0.8em; color: #888; text-align: center;">
            Giorno: <span id="debugDay">-</span> | 
            Caratteri: <span id="contatoreCaratteri">0</span>
        </div>
    </div>
</div>

<!-- Modal Aiuto Immagini -->
<div class="modal-overlay" id="modalAiuto">
    <div class="modal-content" style="max-width: 500px;">
        <h3>üñºÔ∏è Come aggiungere immagini</h3>
        <div style="text-align: left; line-height: 1.6;">
            <p><strong>Metodo consigliato:</strong></p>
            <ol>
                <li>Vai su <a href="https://imgur.com/upload" target="_blank">imgur.com/upload</a></li>
                <li>Carica la tua immagine</li>
                <li>Copia il <strong>link diretto</strong> (che finisce con .jpg, .png)</li>
                <li>Incolla il link nel calendario</li>
                <li>Salva!</li>
            </ol>
            <p><strong>Link esempio:</strong></p>
            <code style="background: #f5f5f5; padding: 5px; border-radius: 3px; display: block; margin: 10px 0;">
                https://i.imgur.com/abc123.jpg
            </code>
            <p><small>‚ùå <strong>Non incollare</strong> immagini direttamente (Ctrl+V) - usano troppo spazio!</small></p>
        </div>
        <div class="azioni" style="margin-top: 20px;">
            <button class="bottone-chiusura" onclick="chiudiAiuto()">Chiudi</button>
        </div>
    </div>
</div>

<script>
    const calendario = document.getElementById("calendario");
    const modale = document.getElementById("modal");
    const modalAiuto = document.getElementById("modalAiuto");
    const editor = document.getElementById("editor");
    const contenutoVisuale = document.getElementById("contenutoVisuale");
    const titoloGiorno = document.getElementById("titoloGiorno");
    const debugDay = document.getElementById("debugDay");
    const contatoreCaratteri = document.getElementById("contatoreCaratteri");
    let currentDay = null;

    // 1. Generazione dinamica dei 24 giorni
    function generaCalendario() {
        calendario.innerHTML = '';
        for (let i = 1; i <= 24; i++) {
            const giorno = document.createElement("button");
            giorno.classList.add("pulsante");
            giorno.innerText = `Giorno ${i}`;
            giorno.setAttribute('data-giorno', i);
            giorno.onclick = () => apriGiornata(i); 
            calendario.appendChild(giorno);
            
            aggiornaStatoPulsante(i);
        }
    }

    // 2. Aggiorna lo stato del pulsante (stellina)
    function aggiornaStatoPulsante(giorno) {
        const pulsante = document.querySelector(`.pulsante[data-giorno="${giorno}"]`);
        if (!pulsante) return;
        
        const savedContent = localStorage.getItem(`giorno${giorno}`);
        if (savedContent && savedContent.trim() !== '' && savedContent !== '<br>') {
            pulsante.classList.add('contenutoSalvato');
        } else {
            pulsante.classList.remove('contenutoSalvato');
        }
    }

    // 3. Funzione per aprire il modale
    function apriGiornata(giorno) {
        console.log("Apertura giorno:", giorno);
        currentDay = giorno;
        debugDay.textContent = giorno;
        titoloGiorno.textContent = `Giorno ${giorno}`;
        
        const savedContent = localStorage.getItem(`giorno${giorno}`);
        console.log("Contenuto salvato:", savedContent);
        
        editor.innerHTML = '';
        
        if (savedContent && savedContent.trim() !== '' && savedContent !== '<br>') {
            editor.innerHTML = savedContent;
        }
        
        aggiornaContatore();
        modale.classList.add("mostra");
        visualizzaContenuto(savedContent);
        
        setTimeout(() => {
            editor.focus();
        }, 100);
    }

    // 4. Funzione per l'anteprima del contenuto
    function visualizzaContenuto(content) {
        contenutoVisuale.innerHTML = '';
        
        if (!content || content.trim() === '' || content === '<br>') {
            contenutoVisuale.innerHTML = '<p style="color: #666; font-style: italic;">Nessun contenuto salvato per questo giorno</p>';
            return;
        }

        const trimmedContent = content.trim();

        // Se √® HTML con immagini o link
        if (trimmedContent.includes('<img') || trimmedContent.includes('<a href') || trimmedContent.includes('<iframe')) {
            contenutoVisuale.innerHTML = trimmedContent;
        }
        // Se √® un link immagine
        else if (trimmedContent.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i)) {
            contenutoVisuale.innerHTML = `
                <div style="text-align: center;">
                    <img src="${trimmedContent}" alt="Immagine" 
                         style="max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"
                         onerror="this.style.display='none'; this.parentNode.innerHTML='<p style=\\'color: red;\\'>‚ùå Immagine non trovata</p>'">
                    <p style="margin-top: 10px; color: #666;">üñºÔ∏è Immagine caricata</p>
                </div>
            `;
        }
        // Se √® un link YouTube
        else if (trimmedContent.includes("youtube.com") || trimmedContent.includes("youtu.be")) {
            const videoId = getYoutubeVideoId(trimmedContent);
            if (videoId) {
                contenutoVisuale.innerHTML = `
                    <div style="text-align: center;">
                        <iframe width="100%" height="250" src="https://www.youtube.com/embed/${videoId}" 
                                frameborder="0" allowfullscreen style="border-radius: 10px;"></iframe>
                        <p style="margin-top: 10px; color: #666;">üé• Video YouTube</p>
                    </div>
                `;
            } else {
                contenutoVisuale.innerHTML = `
                    <a href="${trimmedContent}" target="_blank" 
                       style="display: inline-block; padding: 15px 25px; background: #ff4444; color: white; text-decoration: none; border-radius: 8px; font-weight: bold;">
                        üé• Guarda su YouTube
                    </a>
                `;
            }
        }
        // Se √® un link generico
        else if (trimmedContent.match(/^https?:\/\//i)) {
            contenutoVisuale.innerHTML = `
                <a href="${trimmedContent}" target="_blank" 
                   style="display: inline-block; padding: 15px 25px; background: #4CAF50; color: white; text-decoration: none; border-radius: 8px; font-weight: bold;">
                    üîó Apri Link Esterno
                </a>
                <p style="margin-top: 10px; color: #666; word-break: break-all;">${trimmedContent}</p>
            `;
        }
        // Se √® testo semplice
        else {
            contenutoVisuale.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #4CAF50;">
                    <p style="margin: 0; font-size: 1.1em; line-height: 1.6; white-space: pre-wrap;">${trimmedContent}</p>
                </div>
            `;
        }
    }

    // 5. Funzione helper per YouTube
    function getYoutubeVideoId(url) {
        const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|[^#]*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(regex);
        return (match && match[1]) ? match[1] : null;
    }

    // 6. FUNZIONE SALVA CONTENUTO - SEMPLIFICATA
    function salvaContenuto() {
        if (!currentDay) {
            alert('‚ùå Nessun giorno selezionato!');
            return;
        }

        let content = editor.innerHTML.trim();
        
        // Se vuoto, prova con innerText
        if (!content || content === '<br>') {
            content = editor.innerText.trim();
        }
        
        console.log("Salvataggio giorno", currentDay, "contenuto:", content);

        try {
            localStorage.setItem(`giorno${currentDay}`, content);
            aggiornaStatoPulsante(currentDay);
            visualizzaContenuto(content);
            
            if (content && content !== '<br>') {
                alert(`‚úÖ Contenuto salvato per il Giorno ${currentDay}!`);
            } else {
                alert(`‚ÑπÔ∏è Contenuto vuoto salvato per il Giorno ${currentDay}`);
            }
            
        } catch (error) {
            console.error("Errore salvataggio:", error);
            if (error.name === 'QuotaExceededError') {
                alert('‚ùå Spazio di archiviazione pieno!\n\nElimina qualche contenuto o usa link invece di immagini grandi.');
            }
        }
    }

    // 7. Funzione per eliminare il contenuto
    function eliminaContenuto() {
        if (!currentDay) {
            alert('‚ùå Nessun giorno selezionato!');
            return;
        }
        
        if (confirm(`Sei sicuro di voler eliminare il contenuto del Giorno ${currentDay}?`)) {
            localStorage.removeItem(`giorno${currentDay}`);
            editor.innerHTML = '';
            aggiornaStatoPulsante(currentDay);
            visualizzaContenuto('');
            aggiornaContatore();
            alert(`üóëÔ∏è Contenuto del Giorno ${currentDay} eliminato!`);
        }
    }

    // 8. Funzione per inserire testo esempio
    function inserisciTestoEsempio() {
        const esempi = [
            "üéÑ Buon Natale! üéÖ",
            "üåü Che la magia del Natale riempia il tuo cuore di gioia!",
            "‚ùÑÔ∏è Auguri meravigliosi per te e la tua famiglia!",
            "üéÅ Il miglior regalo √® stare insieme!",
            "üïØÔ∏è Che questa stagione porti pace e felicit√†!",
            "‚ú® Che il tuo Natale sia luminoso e speciale!"
        ];
        const esempioCasuale = esempi[Math.floor(Math.random() * esempi.length)];
        
        if (editor.innerHTML.trim() === '' || editor.innerHTML === '<br>') {
            editor.innerHTML = esempioCasuale;
        } else {
            editor.innerHTML += '<br><br>' + esempioCasuale;
        }
        aggiornaContatore();
    }

    // 9. Funzione per mostrare aiuto immagini
    function mostraAiutoImmagini() {
        modalAiuto.classList.add("mostra");
    }

    function chiudiAiuto() {
        modalAiuto.classList.remove("mostra");
    }

    // 10. Funzione per chiudere il modale
    function chiudiModale() {
        modale.classList.remove("mostra");
        currentDay = null;
        debugDay.textContent = '-';
    }

    // 11. Aggiorna contatore caratteri
    function aggiornaContatore() {
        const text = editor.innerText || editor.textContent;
        contatoreCaratteri.textContent = text.length;
    }

    // 12. Event listeners
    modale.addEventListener('click', function(e) {
        if (e.target === modale) {
            chiudiModale();
        }
    });

    modalAiuto.addEventListener('click', function(e) {
        if (e.target === modalAiuto) {
            chiudiAiuto();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (modale.classList.contains('mostra')) chiudiModale();
            if (modalAiuto.classList.contains('mostra')) chiudiAiuto();
        }
    });

    editor.addEventListener('input', aggiornaContatore);

    // 13. Gestione incolla - converte immagini in testo
    editor.addEventListener('paste', function(e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                e.preventDefault();
                const blob = item.getAsFile();
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const dataUrl = event.target.result;
                    // Invece di inserire l'immagine, mostra avviso
                    const warning = document.createElement('div');
                    warning.style.background = '#fff3cd';
                    warning.style.padding = '10px';
                    warning.style.borderRadius = '5px';
                    warning.style.border = '1px solid #ffeaa7';
                    warning.style.margin = '10px 0';
                    warning.innerHTML = 'üñºÔ∏è <strong>Immagine rilevata</strong><br>' +
                                      'Per salvare immagini, usa il metodo con link esterni. ' +
                                      '<button onclick="mostraAiutoImmagini()" style="background: #007bff; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px;">Aiuto</button>';
                    
                    if (editor.innerHTML.trim() === '' || editor.innerHTML === '<br>') {
                        editor.innerHTML = '';
                    }
                    editor.appendChild(warning);
                    aggiornaContatore();
                };
                
                reader.readAsDataURL(blob);
                return;
            }
        }
        // Se non √® un'immagine, permetti l'incolla normale
        setTimeout(aggiornaContatore, 0);
    });

    // 14. Inizializzazione
    document.addEventListener('DOMContentLoaded', function() {
        generaCalendario();
        console.log("Calendario dell'Avvento inizializzato!");
    });

</script>

</body>
</html>
